const fs = require('fs');
const path = require('path');

// Fix the sonar report generated by @bdellegrazie/playwright-sonar-reporter
function fixSonarReport() {
  const reportPath = path.join(__dirname, '../test-results/sonar-report.xml');
  const fixedReportPath = path.join(__dirname, '../test-results/sonar-test-report.xml');
  
  if (!fs.existsSync(reportPath)) {
    console.log('Original sonar-report.xml not found');
    return;
  }
  
  let content = fs.readFileSync(reportPath, 'utf8');
  
  // Add XML declaration if missing
  if (!content.startsWith('<?xml')) {
    content = '<?xml version="1.0" encoding="UTF-8"?>\n' + content;
  }
  
  // Fix absolute paths to relative paths
  content = content.replace(/path="[^"]*\/([^\/]+\.spec\.ts)"/g, 'path="tests/$1"');
  
  // Fix empty failure elements
  content = content.replace(/<failure>\s*<\/failure>/g, '<failure message="Test failed">Assertion failed</failure>');
  
  // Fix empty skipped elements
  content = content.replace(/<skipped>\s*<\/skipped>/g, '<skipped message="Test skipped">Test was skipped</skipped>');
  
  // Remove any malformed elements
  content = content.replace(/<testCase([^>]*)>\s*<\/testCase>/g, '<testCase$1/>');
  
  // Write the fixed content
  fs.writeFileSync(fixedReportPath, content, 'utf8');
  console.log('Fixed sonar report XML format');
  console.log('Original:', reportPath);
  console.log('Fixed:', fixedReportPath);
}

fixSonarReport();